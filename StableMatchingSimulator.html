<div id="bigBoi" style="text-align:center;">
  <div id="problemExplanationWrapper">
    <p>
      Let's say that you have <i>n</i> pets who need to be adopted by <i>n</i> families.
      <br>
      <br>
      Each animal is adopted by one family, and each family adopts one animal.
      <br>
      <br>
      Each animal has a list of which families they prefer, and each family has a list of which animals it prefers.
      <br>
      <br>
      Can we construct an algorithm to match animals to families such that there are no cases where both an animal and a family would prefer each other over the matches they have been assigned? 
      <br>
      <br>
      In other words, can we construct a matching with no unstable pairings?
      <br>
      <br>
      <br>
      Can we come up with an algorithm of O(n) to do so?
    </p>
  </div>
  
  <div id="sandboxWrapper" style="text-align:center;">
    <script>
      document.addEventListener("DOMContentLoaded", function(event) {
        var n = 5; //The number of students and schools
        
        var stPrefs = [];  //The preference lists of the students
        
        var schPrefs = []; //The preference lists of the schools
        
        var visualizerRows = [];  //The list of rows to be deleted on an update
        var prefRows = [];  //The list of rows to be deleted on an update
        
        var dropdowns = [];   //The list of the dropdowns used by the user to create matchings
        
        var letters = ['a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z'];  //letters
        
        repopulate();  //First things first, generate the students and schools
        
        setInterval(checkN, 500); //Every 500 millis checks to see if n has changed
        
        //Update Line Height to Fit
        setInterval(function(){
          console.log(document.getElementById("visualizerTable").style);
          document.getElementById("line").style.height = document.getElementById("visualizerTable").clientHeight;
        }, 100);
  
        //Checks if n has changed
        function checkN(){
          var newN = document.getElementById("nInput").value;
          if(newN != n && newN > 0 && newN < 16){
            n = newN;
            
            repopulate();
          }
        }
        
        //If n has changed or if this is the beginning of the program:
        function repopulate(){
          //Clear #visualizerTable
          for(var i = 0; i < visualizerRows.length; i++){
           document.getElementById("visualizerTable").removeChild(visualizerRows[i]);
          }
          
          visualizerRows = [];
          
          //Clear #preferenceListTable
          for(var i = 0; i < prefRows.length; i++){
           document.getElementById("preferenceListTable").removeChild(prefRows[i]);
          }
          
          prefRows = [];
          
          //Clear dropdowns, prefLists
          dropdowns = [];
          stPrefs = [];
          schPrefs = [];
          
          //Generate enough rows of #visualizerTable and #preferenceListTable
          for(var i = 0; i < n; i++){
            //First, visualizerTable
            var visRow = document.createElement("tr");
            visRow.id = "visRow" + i;
            
            var stCell = document.createElement("td");
            stCell.id = "stCell" + i;
            
            var stNum = document.createElement("p");
            stNum.id = "stNum" + i;
            stNum.innerHTML = i;
            stNum.style = "border-style:solid;border-width:1px;margin:5px;padding:5px;";
            
            var schCell = document.createElement("td");
            schCell.id = "schCell" + i;
            
            var schNum = document.createElement("select");
            schNum.id = "schNum" + i;
            schNum.style = "border-style:solid;border-width:1px;margin:5px;padding:5px;";
            for(var j = 0; j < n; j++){
              var option = document.createElement("option");
              option.id = "schNum" + i + "Option" + j;
              option.value = letters[j];
              option.innerHTML = letters[j];
              
              schNum.appendChild(option);
            }
              
            dropdowns.push(schNum);
            
            stCell.appendChild(stNum);
            schCell.appendChild(schNum);
            visRow.appendChild(stCell);
            visRow.appendChild(schNum);
            document.getElementById("visualizerTable").appendChild(visRow);
            
            visualizerRows.push(visRow);
            
            //Then, preferenceListTable
            var prefRow = document.createElement("tr");
            prefRow.id = "prefRow" + i;
  
            //columns
            var prefStCell = document.createElement("td");
            prefStCell.id = "prefStCell" + i;
  
            var prefStPrefCell = document.createElement("td");
            prefStPrefCell.id = "prefStPrefCell" + i;
  
            var prefSchCell = document.createElement("td");
            prefSchCell.id = "prefSchCell" + i;
  
            var prefSchPrefCell = document.createElement("td");
            prefSchPrefCell.id = "prefSchPrefCell" + i;
  
            var prefStNum = document.createElement("p");
            prefStNum.id = "prefStNum" + i;
            prefStNum.innerHTML = i;
            prefStNum.style = "border-style:solid;border-width:1px;margin:5px;padding:5px;";
  
            var prefStList = document.createElement("p");
            prefStList.id = "prefStList" + i;
            var stPref = makePrefLists2(n);
            stPrefs.push(stPref)
            prefStList.innerHTML = stPref;
            prefStList.style = "border-style:solid;border-width:1px;margin:5px;padding:5px;";
  
            var prefSchNum = document.createElement("p");
            prefSchNum.id = "prefSchNum" + i;
            prefSchNum.innerHTML = letters[i];
            prefSchNum.style = "border-style:solid;border-width:1px;margin:5px;padding:5px;";
  
            var prefSchList = document.createElement("p");
            prefSchList.id = "prefSchList" + i;
            var schPref = makePrefLists(n);
            schPrefs.push(schPref);
            prefSchList.innerHTML = schPref;
            prefSchList.style = "border-style:solid;border-width:1px;margin:5px;padding:5px;";
  
  
            //student id
            prefStCell.appendChild(prefStNum);
            prefRow.appendChild(prefStCell);
  
            //student pref
            prefStPrefCell.appendChild(prefStList);
            prefRow.appendChild(prefStPrefCell);
  
            //school id
            prefSchCell.appendChild(prefSchNum);
            prefRow.appendChild(prefSchCell);
  
            //school preferences
            prefSchPrefCell.appendChild(prefSchList);
            prefRow.appendChild(prefSchPrefCell);
  
            document.getElementById("preferenceListTable").appendChild(prefRow);
            
            prefRows.push(prefRow);
          }
        }
        
        
        function makePrefLists(n){
          var listLen = [];
          var prefList = [];
  
          //fill the number choice list
          for(i=0; i<n; i++){
            listLen.push(i);
          }
  
          //fill the prefList
          while(listLen.length!=0){
            var rand = Math.floor(Math.random()*listLen.length);
            prefList.push(listLen[rand]);
            listLen.splice(rand, 1);
          }
          return prefList;
        }
        
       function makePrefLists2(n){
         //var letters = ['a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z'];
        var listLen = [];
        var prefList = [];

        for(var i=0; i<n; i++){
          listLen.push(letters[i]);
        }
        while(listLen.length!=0){
          var rand = Math.floor(Math.random()*listLen.length);
          prefList.push(listLen[rand]);
          listLen.splice(rand, 1);
        }
        return prefList;
      }
        
        
        //setInterval(checkMatched, 100); //Every 500 millis checks to see if a stable matching exists
        setInterval(allMatchCheck(), 100);
        function checkMatched(){
          //Check to see if a matching exists
          // If it doesn't, set #isMatchedBox to white, #isMatchedText to "No Matching"
          // If it does, check to see if it's stable
          //  If it is, set #isMatchedBox to green, #isMatchedText to "Matching is Stable"
          //  If it isn't, set #isMatchedBox to red#isMatchedText to "Matching is NOT Stable"
          
          var matching = true;  //Is there a matching?
          var matchedVals = [];
          for(var i = 0; i < dropdowns.length; i++){
            var val = dropdowns[i].value;
            if(matchedVals.includes(val)){ //This is a repeat, so no matching
              noMatching();
              matching = false;
            }else{
              matchedVals.push(val);
            }
          }
          
          if(matching){
            var stable = true;  //We assume that the matching is stable, then try to disprove
            
            //Check if matching is stable:
            for(var i = 0; i < n; i++){  //For each student-school pairing
              var student = i;
              var school = dropdowns[i].value;
              var schoolIndex = letters.indexOf(school);
              
              //Get prefered schools
              var preferredSchools = [];
              var prefList = stPrefs[i];
              var doneChecking = false;
              for(var j = 0; j < prefList.length; j++){
                if(!doneChecking){
                  if(prefList[j] != school){ //prefList[j] is a school which the student would prefer
                   preferredSchools.push(prefList[j]);
                  }else{ //No more schools to check
                   doneChecking = true;
                  }
                }
              }
              
              //For each preferred school:
              for(var j = 0; j < preferredSchools.length; j++){
                //Find the student paired with this school
                var pairedStudent = -1;
                for(var k = 0; k < dropdowns.length; k++){
                  if(dropdowns[k].value == preferredSchools[j]){ //This dropdown is the pairing in question
                   pairedStudent = k;
                  }
                }
                
                //Does the school prefer student or pairedStudent? If so, unstable
                var schoolPrefList = schPrefs[letters.indexOf(school)];
                if(schoolPrefList.indexOf(pairedStudent) > schoolPrefList.indexOf(student)){
                 stable = false;
                }
              }
            }
            
            console.log(stable);
            
            //Update the view to reflect the reality of stability
            if(stable){
              stableMatching();
            }else{
              unstableMatching();
            }
          }
        }
        
        function allMatchCheck(){
          var matching = true;  //Is there a matching?
          var matchedVals = [];
          for(var i = 0; i < dropdowns.length; i++){
            var val = dropdowns[i].value;
            if(matchedVals.includes(val)){ //This is a repeat, so no matching
              noMatching();
              matching = false;
            }else{
              matchedVals.push(val);
            }
          }

          if(matching){
            var stable = true; //assume matching is stable, try to disprove
          }

          //make all possible matches
          var possibleMatchesStu = [];
          var possibleMatchesSch = [];
          for (var x = 0; x< n; x++){
            for (var y = 0; y < n; y++){
              possibleMatchesStu.push(x);
              possibleMatchesSch.push(letters[y]);
            }
          }
          //check if stable
          for(var i = 0; i < n; i++){  //For each student-school pairing
              var student = i;
              var school = dropdowns[i].value;
              var schoolIndex = letters.indexOf(school);
              
              //Get prefered schools
              var preferredSchools = [];
              var prefList = stPrefs[i];
              var doneChecking = false;
              for(var j = 0; j < prefList.length; j++){
                if(!doneChecking){
                  if(prefList[j] != school){ //prefList[j] is a school which the student would prefer
                   preferredSchools.push(prefList[j]);
                  }else{ //No more schools to check
                   doneChecking = true;
                  }
                }
              }

            
            //go through the possible matches and check if it is in the current matching
            for (var k = 0; k<possibleMatchesStu.length; k++){
              //if it is not, then check for instability
              if(!(possibleMatchesStu[k]==student && possibleMatchesSch==school)){
                //if the match is an instability, then it is not stable
                
                //for each preferred school, see if it matches this possible match
                for(var z =0; z <preferredSchools.length; z++){
                  var pairedStudent = -1;
                  for(var q = 0; q<dropdowns.length; q++){
                    //if the dropdown matches the unpaired
                    if(dropdowns[q].value == possibleMatchesSch[k]){
                      pairedStudent = q;
                    }
                  }

                  //does the school prefer student or currentPaired student?
                  var schoolPrefList = schPrefs[letters.indexOf(school)];

                  if(schoolPrefList.includes(possibleMatchesStu[k])){
                    stable = false;
                  }
                }
      
              }

            }
            if(stable){
              stableMatching();
            }else{
              unstableMatching();
            }
          }
      }

        function noMatching(){
          document.getElementById("isMatchedBox").style = "text-align:center; border-style:solid; border-width:1px; margin:15px; width:90%; height:150px; line-height:150px; background-color: white;";
          document.getElementById("isMatchedText").innerHTML = "Not a match, families have been assigned multiple animals.";
        }
        
        function stableMatching(){
          document.getElementById("isMatchedBox").style = "text-align:center; border-style:solid; border-width:1px; margin:15px; width:90%; height:150px; line-height:150px; background-color: green;";
          document.getElementById("isMatchedText").innerHTML = "The Matching is Stable";
        }
        
        function unstableMatching(){
          document.getElementById("isMatchedBox").style = "text-align:center; border-style:solid; border-width:1px; margin:15px; width:90%; height:150px; line-height:150px; background-color: red;";
          document.getElementById("isMatchedText").innerHTML = "The Matching is NOT Stable";
        }
        
      });
    </script>
    <b>Number of animals and families:</b>
    <input type="text" value=5 id="nInput">
    
    <div id="isMatchedBox" style="text-align:center; border-style:solid; border-width:1px; width:90%; height:150px; line-height:150px; background-color: white;">
      <p id="isMatchedText">Not a match, families have been assigned multiple animals.</p>
    </div>
    
    <div id="tableWrapper">
      <table id="preferenceListTable" align="center" style=" vertical-align: top; float:left;">
        <tr>
          <th style="border-style:solid;border-width:1px;margin:5px;padding:5px;">Animal ID</th>
          <th style="border-style:solid;border-width:1px;margin:5px;padding:5px;">Animal's Preferences</th>
          <th style="border-style:solid;border-width:1px;margin:5px;padding:5px;">Family ID</th>
          <th style="border-style:solid;border-width:1px;margin:5px;padding:5px;">Family's Preferences</th>
        </tr>
        <caption align="bottom"><b><a href = "GaleShapleyAlgorithm.html">Click here to view an explanation of the algorithm to create stable matches</b></caption>
      </table>
      <div id="line" style="border-style:solid; border-wdith:1px; width:0px; height:0px; margin-left:10px; margin-right:10px; float:left;"></div>
      <table id="visualizerTable" align="center" style=" vertical-align: top; float:left;">
        <tr>
          <th style="border-style:solid;border-width:1px;margin:5px;padding:5px;">Animal</th>
          <th style="border-style:solid;border-width:1px;margin:5px;padding:5px;">Family</th>
        </tr>

      </table>
    </div>
  </div>
</div>
